import React, { useState, useMemo, useEffect } from 'react';
import { 
  Trophy, Activity, Shield, Target, Crown, 
  Scale, Flame, Globe, Save, Trash2, 
  BarChart2, Users, Layout, Plus, CheckSquare, Square, X,
  ChevronDown, ChevronUp, Edit3 // Added Edit icon
} from 'lucide-react';

// --- HELPER COMPONENTS ---
const MedalIcon = ({className}) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
);

const Slider = ({ label, value, onChange }) => (
  <div className="mb-3 last:mb-0">
    <div className="flex justify-between items-center mb-1">
      <span className="text-[11px] font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide truncate pr-2">{label}</span>
      <span className="text-xs font-bold text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-2 py-0.5 rounded">{value}</span>
    </div>
    <input
      type="range" min="0" max="10" step="0.5" value={value}
      onChange={(e) => onChange(parseFloat(e.target.value))}
      className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-blue-600"
    />
  </div>
);

// --- 1. CONFIGURATION & CATEGORIES ---
const CATEGORIES = {
  individual_annual: {
    label: "I-A. Annual Honors",
    icon: <Crown className="w-4 h-4" />,
    color: "text-amber-500",
    description: "Global individual recognition.",
    fields: {
      ballonDor: "Ballon d'Or",
      theBest: "FIFA The Best",
      laureus: "Laureus Award",
      euroGoldenShoe: "European Golden Shoe",
      goldenBoy: "Golden Boy / Kopa",
      puskas: "Puskas Award"
    }
  },
  individual_league: {
    label: "I-B. League Honors",
    icon: <MedalIcon className="w-4 h-4" />,
    color: "text-amber-600",
    description: "Domestic dominance.",
    fields: {
      leagueGoldenBoot: "League Golden Boot",
      leagueAssistKing: "League Assist Leader"
    }
  },
  individual_cup: {
    label: "I-C. Cup Honors",
    icon: <Trophy className="w-4 h-4" />,
    color: "text-amber-700",
    description: "Continental & International individual awards.",
    fields: {
      uclGoldenBoot: "UCL Golden Boot",
      uclAssistKing: "UCL Assist Leader",
      intlGoldenBoot: "Intl. Tournament Golden Boot",
      intlMvp: "Intl. Tournament MVP"
    }
  },
  team_national: {
    label: "II-A. National Team",
    icon: <Globe className="w-4 h-4" />,
    color: "text-blue-600",
    description: "World Cup & Continental achievements.",
    fields: {
      worldCup: "World Cup Winner",
      continental: "Continental Cup (Euro/Copa)",
      finalissima: "Finalissima / Confed Cup",
      nationsLeague: "Nations League"
    }
  },
  team_club: {
    label: "II-B. Club Team",
    icon: <Shield className="w-4 h-4" />,
    color: "text-blue-800",
    description: "UCL & Leagues.",
    fields: {
      ucl: "UCL Winner",
      leagueTitle: "Top 5 League Title",
      domesticCup: "Domestic Cup",
      cwc: "Club World Cup"
    }
  },
  stats_scoring: {
    label: "III-A. Scoring Stats",
    icon: <Target className="w-4 h-4" />,
    color: "text-red-500",
    description: "Goals & efficiency.",
    fields: {
      goals: "Total Goals",
      gpm: "Goals Per Match",
      shotsPerMatch: "Shots Per Match",
      conversionRate: "Conversion Rate (%)",
      penalties: "Penalty Goals"
    }
  },
  stats_playmaking: {
    label: "III-B. Playmaking",
    icon: <Activity className="w-4 h-4" />,
    color: "text-purple-500",
    description: "Creativity & Progression.",
    fields: {
      assists: "Total Assists",
      apm: "Assists Per Match",
      keyPasses: "Key Passes Per Match",
      bigChances: "Big Chances Created"
    }
  },
  stats_dribbling: {
    label: "III-C. Dribbling",
    icon: <Flame className="w-4 h-4" />,
    color: "text-orange-500",
    description: "1v1 Ability.",
    fields: {
      dribblesPerMatch: "Dribbles Per Match",
      dribbleSuccess: "Dribble Success Rate (%)"
    }
  },
  stats_defense: {
    label: "III-D. Defense & Physical",
    icon: <Shield className="w-4 h-4" />,
    color: "text-green-600",
    description: "Work rate & duels.",
    fields: {
      tackles: "Tackles Per Match",
      interceptions: "Interceptions Per Match",
      duelsWon: "Duels Won Per Match",
      cleanSheets: "Clean Sheets (GK/DEF)"
    }
  },
  stats_overall: {
    label: "III-E. Overall / Errors",
    icon: <Scale className="w-4 h-4" />,
    color: "text-gray-600",
    description: "Ratings & reliability.",
    fields: {
      avgRating: "Avg Match Rating",
      motm: "Man of the Match",
      errorProne: "Errors Leading to Goal (Negative)" 
    }
  }
};

// --- 2. TEMPLATES (PRESETS) ---
const DEFAULT_PRESETS = {
  universal: {
    name: "Universal / Balanced",
    weights: {
      ballonDor: 8, theBest: 6, laureus: 2, euroGoldenShoe: 5, goldenBoy: 2, puskas: 1,
      leagueGoldenBoot: 5, leagueAssistKing: 5, uclGoldenBoot: 6, uclAssistKing: 5, intlGoldenBoot: 7, intlMvp: 8,
      worldCup: 10, continental: 8, finalissima: 3, nationsLeague: 2,
      ucl: 9, leagueTitle: 7, domesticCup: 3, cwc: 2,
      goals: 8, gpm: 7, shotsPerMatch: 3, conversionRate: 5, penalties: 2,
      assists: 8, apm: 7, keyPasses: 6, bigChances: 6,
      dribblesPerMatch: 5, dribbleSuccess: 4,
      tackles: 4, interceptions: 4, duelsWon: 4, cleanSheets: 1,
      avgRating: 8, motm: 5, errorProne: 2
    }
  },
  striker: {
    name: "Forward - Center Forward (No. 9)",
    weights: {
      ballonDor: 9, euroGoldenShoe: 10, leagueGoldenBoot: 10, uclGoldenBoot: 10, intlGoldenBoot: 9,
      worldCup: 8, ucl: 8, leagueTitle: 7,
      goals: 10, gpm: 10, shotsPerMatch: 8, conversionRate: 9, penalties: 5,
      assists: 3, keyPasses: 2, dribblesPerMatch: 3,
      tackles: 0, cleanSheets: 0, avgRating: 7, motm: 8
    }
  },
  winger: {
    name: "Forward - Winger / Inside Forward",
    weights: {
      ballonDor: 8, leagueAssistKing: 8, uclAssistKing: 8, intlMvp: 8,
      goals: 7, gpm: 6, conversionRate: 5,
      assists: 9, apm: 9, keyPasses: 9, bigChances: 9,
      dribblesPerMatch: 10, dribbleSuccess: 8,
      avgRating: 8, motm: 8
    }
  },
  playmaker: {
    name: "Midfielder - Playmaker (No. 10)",
    weights: {
      ballonDor: 8, leagueAssistKing: 10, uclAssistKing: 10, intlMvp: 9,
      goals: 4, assists: 10, apm: 10, keyPasses: 10, bigChances: 10,
      dribblesPerMatch: 7, dribbleSuccess: 8,
      avgRating: 9, motm: 7
    }
  },
  b2b: {
    name: "Midfielder - Box-to-Box (CM)",
    weights: {
      leagueTitle: 8, ucl: 8,
      goals: 3, assists: 6, keyPasses: 7,
      tackles: 7, interceptions: 7, duelsWon: 8,
      avgRating: 9, motm: 5
    }
  },
  dm: {
    name: "Midfielder - Defensive (CDM)",
    weights: {
      leagueTitle: 8, ucl: 8,
      assists: 3, keyPasses: 4,
      tackles: 10, interceptions: 10, duelsWon: 10,
      avgRating: 8
    }
  },
  fullback: {
    name: "Defender - Full Back / Wing Back",
    weights: {
      leagueTitle: 8, ucl: 8,
      assists: 7, keyPasses: 6, dribblesPerMatch: 5,
      tackles: 8, interceptions: 8, duelsWon: 7, cleanSheets: 6,
      avgRating: 8
    }
  },
  centerback: {
    name: "Defender - Center Back",
    weights: {
      leagueTitle: 9, ucl: 9, worldCup: 9,
      goals: 1, assists: 1,
      tackles: 9, interceptions: 9, duelsWon: 10, cleanSheets: 10,
      avgRating: 8
    }
  },
  goalkeeper: {
    name: "Goalkeeper",
    weights: {
      leagueTitle: 9, ucl: 9, worldCup: 9,
      cleanSheets: 10, avgRating: 9,
      goals: 0, assists: 0, tackles: 0
    }
  }
};

// --- 3. MOCK DATA INITIAL ---
const INITIAL_PLAYERS_DATA = [
  {
    id: 1, name: "Lionel Messi", team: "ARG", 
    stats: {
      ballonDor: 8, theBest: 2, laureus: 2, euroGoldenShoe: 6, goldenBoy: 1, puskas: 0,
      leagueGoldenBoot: 8, leagueAssistKing: 6, uclGoldenBoot: 6, uclAssistKing: 3, intlGoldenBoot: 1, intlMvp: 3,
      worldCup: 1, continental: 2, finalissima: 1, nationsLeague: 0,
      ucl: 4, leagueTitle: 12, domesticCup: 7, cwc: 3,
      goals: 838, gpm: 0.79, shotsPerMatch: 5.2, conversionRate: 18, penalties: 110,
      assists: 374, apm: 0.35, keyPasses: 3.2, bigChances: 350,
      dribblesPerMatch: 4.5, dribbleSuccess: 62,
      tackles: 0.4, interceptions: 0.3, duelsWon: 4.5, cleanSheets: 0,
      avgRating: 8.65, motm: 320, errorProne: 0
    }
  },
  {
    id: 2, name: "Cristiano Ronaldo", team: "POR",
    stats: {
      ballonDor: 5, theBest: 2, laureus: 0, euroGoldenShoe: 4, goldenBoy: 0, puskas: 1,
      leagueGoldenBoot: 5, leagueAssistKing: 0, uclGoldenBoot: 7, uclAssistKing: 1, intlGoldenBoot: 1, intlMvp: 0,
      worldCup: 0, continental: 1, finalissima: 0, nationsLeague: 1,
      ucl: 5, leagueTitle: 7, domesticCup: 4, cwc: 4,
      goals: 895, gpm: 0.74, shotsPerMatch: 6.1, conversionRate: 16, penalties: 163,
      assists: 240, apm: 0.20, keyPasses: 1.6, bigChances: 100,
      dribblesPerMatch: 2.1, dribbleSuccess: 55,
      tackles: 0.3, interceptions: 0.2, duelsWon: 3.5, cleanSheets: 0,
      avgRating: 8.05, motm: 180, errorProne: 0
    }
  },
  {
    id: 3, name: "Zinedine Zidane", team: "FRA",
    stats: {
      ballonDor: 1, theBest: 3, laureus: 0, euroGoldenShoe: 0, goldenBoy: 0, puskas: 0,
      leagueGoldenBoot: 0, leagueAssistKing: 2, uclGoldenBoot: 0, uclAssistKing: 1, intlGoldenBoot: 0, intlMvp: 2,
      worldCup: 1, continental: 1, finalissima: 0, nationsLeague: 0,
      ucl: 1, leagueTitle: 3, domesticCup: 2, cwc: 2,
      goals: 156, gpm: 0.20, shotsPerMatch: 2.1, conversionRate: 12, penalties: 20,
      assists: 180, apm: 0.25, keyPasses: 3.0, bigChances: 150,
      dribblesPerMatch: 2.5, dribbleSuccess: 65,
      tackles: 1.5, interceptions: 1.2, duelsWon: 5.0, cleanSheets: 0,
      avgRating: 8.3, motm: 90, errorProne: 0
    }
  },
  {
    id: 4, name: "Ronaldo Nazario", team: "BRA",
    stats: {
      ballonDor: 2, theBest: 3, laureus: 1, euroGoldenShoe: 1, goldenBoy: 0, puskas: 0,
      leagueGoldenBoot: 3, leagueAssistKing: 0, uclGoldenBoot: 0, uclAssistKing: 0, intlGoldenBoot: 1, intlMvp: 2,
      worldCup: 2, continental: 2, finalissima: 1, nationsLeague: 0,
      ucl: 0, leagueTitle: 2, domesticCup: 3, cwc: 1,
      goals: 414, gpm: 0.67, shotsPerMatch: 4.5, conversionRate: 22, penalties: 40,
      assists: 105, apm: 0.17, keyPasses: 1.5, bigChances: 120,
      dribblesPerMatch: 4.8, dribbleSuccess: 68,
      tackles: 0.3, interceptions: 0.2, duelsWon: 3.0, cleanSheets: 0,
      avgRating: 8.4, motm: 110, errorProne: 0
    }
  },
  {
    id: 5, name: "Paolo Maldini", team: "ITA",
    stats: {
      ballonDor: 0, theBest: 0, laureus: 0, euroGoldenShoe: 0, goldenBoy: 0, puskas: 0,
      leagueGoldenBoot: 0, leagueAssistKing: 0, uclGoldenBoot: 0, uclAssistKing: 0, intlGoldenBoot: 0, intlMvp: 0,
      worldCup: 0, continental: 0, finalissima: 0, nationsLeague: 0,
      ucl: 5, leagueTitle: 7, domesticCup: 1, cwc: 3,
      goals: 40, gpm: 0.04, shotsPerMatch: 0.3, conversionRate: 5, penalties: 0,
      assists: 40, apm: 0.04, keyPasses: 0.5, bigChances: 10,
      dribblesPerMatch: 0.5, dribbleSuccess: 70,
      tackles: 3.8, interceptions: 3.5, duelsWon: 7.5, cleanSheets: 350,
      avgRating: 8.5, motm: 50, errorProne: 0
    }
  },
  {
    id: 6, name: "Manuel Neuer", team: "GER",
    stats: {
      ballonDor: 0, theBest: 0, laureus: 0, euroGoldenShoe: 0, goldenBoy: 0, puskas: 0,
      leagueGoldenBoot: 0, leagueAssistKing: 0, uclGoldenBoot: 0, uclAssistKing: 0, intlGoldenBoot: 0, intlMvp: 0,
      worldCup: 1, continental: 0, finalissima: 0, nationsLeague: 0,
      ucl: 2, leagueTitle: 11, domesticCup: 6, cwc: 2,
      goals: 0, gpm: 0, shotsPerMatch: 0, conversionRate: 0, penalties: 0,
      assists: 7, apm: 0.01, keyPasses: 0.1, bigChances: 0,
      dribblesPerMatch: 0.1, dribbleSuccess: 100,
      tackles: 0.5, interceptions: 1.0, duelsWon: 1.0, cleanSheets: 300,
      avgRating: 8.1, motm: 40, errorProne: 2
    }
  },
  {
    id: 7, name: "Kevin De Bruyne", team: "BEL",
    stats: {
      ballonDor: 0, theBest: 0, laureus: 0, euroGoldenShoe: 0, goldenBoy: 0, puskas: 0,
      leagueGoldenBoot: 0, leagueAssistKing: 4, uclGoldenBoot: 0, uclAssistKing: 2, intlGoldenBoot: 0, intlMvp: 0,
      worldCup: 0, continental: 0, finalissima: 0, nationsLeague: 0,
      ucl: 1, leagueTitle: 6, domesticCup: 5, cwc: 1,
      goals: 150, gpm: 0.28, shotsPerMatch: 2.5, conversionRate: 14, penalties: 10,
      assists: 295, apm: 0.55, keyPasses: 3.8, bigChances: 320,
      dribblesPerMatch: 1.4, dribbleSuccess: 65,
      tackles: 1.4, interceptions: 0.9, duelsWon: 4.0, cleanSheets: 0,
      avgRating: 8.2, motm: 100, errorProne: 0
    }
  }
];

// --- MAIN APP ---
export default function FootballRankerV3() {
  // State
  const [players, setPlayers] = useState(INITIAL_PLAYERS_DATA);
  const [weights, setWeights] = useState(DEFAULT_PRESETS.universal.weights);
  const [currentPresetName, setCurrentPresetName] = useState('Universal / Balanced');
  const [customPresets, setCustomPresets] = useState({});
  const [selectedPlayers, setSelectedPlayers] = useState(INITIAL_PLAYERS_DATA.map(p => p.id));
  const [viewMode, setViewMode] = useState('rankings'); 
  const [expandedCat, setExpandedCat] = useState('individual_annual');
  
  // Edit Mode State
  const [editingPlayer, setEditingPlayer] = useState(null); // The full player object being edited
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);

  // Load custom presets from local storage on mount (Simulation)
  useEffect(() => {
    // In a real app, localStorage.getItem('custom_presets')
  }, []);

  const handlePresetChange = (key) => {
    if (key.startsWith('custom_')) {
      const customKey = key.replace('custom_', '');
      if (customPresets[customKey]) {
        setWeights(customPresets[customKey].weights);
        setCurrentPresetName(customPresets[customKey].name);
      }
    } else if (DEFAULT_PRESETS[key]) {
      setWeights(DEFAULT_PRESETS[key].weights);
      setCurrentPresetName(DEFAULT_PRESETS[key].name);
    }
  };

  const saveCustomPreset = () => {
    const name = prompt("Enter a name for this custom template:", "My Custom Weights");
    if (name) {
      const id = Date.now().toString();
      setCustomPresets(prev => ({
        ...prev,
        [id]: { name, weights: {...weights} }
      }));
      setCurrentPresetName(name);
    }
  };

  const togglePlayerSelection = (id) => {
    if (selectedPlayers.includes(id)) {
      setSelectedPlayers(prev => prev.filter(pid => pid !== id));
    } else {
      setSelectedPlayers(prev => [...prev, id]);
    }
  };

  const selectAllPlayers = () => setSelectedPlayers(players.map(p => p.id));
  const deselectAllPlayers = () => setSelectedPlayers([]);

  // --- EDITING LOGIC ---
  const openEditModal = (player, e) => {
    e.stopPropagation(); // Prevent row click from triggering twice if needed
    setEditingPlayer(JSON.parse(JSON.stringify(player))); // Deep copy
    setIsEditModalOpen(true);
  };

  const handleEditChange = (key, value) => {
    setEditingPlayer(prev => ({
      ...prev,
      stats: {
        ...prev.stats,
        [key]: parseFloat(value) || 0
      }
    }));
  };

  const savePlayerEdits = () => {
    setPlayers(prev => prev.map(p => p.id === editingPlayer.id ? editingPlayer : p));
    setIsEditModalOpen(false);
    setEditingPlayer(null);
  };

  // --- CALCULATION ENGINE ---
  const rankedData = useMemo(() => {
    // 1. Calculate Max Values for Normalization
    const maxStats = {};
    const allStatKeys = new Set();
    Object.values(CATEGORIES).forEach(cat => {
      Object.keys(cat.fields).forEach(k => allStatKeys.add(k));
    });

    allStatKeys.forEach(key => {
      // Find max value in dataset for this stat based on CURRENT state
      const maxVal = Math.max(...players.map(p => p.stats[key] || 0));
      maxStats[key] = maxVal === 0 ? 1 : maxVal;
    });

    // 2. Score Players
    const scored = players.map(player => {
      let totalScore = 0;
      
      allStatKeys.forEach(key => {
        const val = player.stats[key] || 0;
        const w = weights[key] || 0;
        if (w > 0) {
          // Score = (Value / Max) * Weight * 5
          const point = (val / maxStats[key]) * w * 5;
          totalScore += point;
        }
      });

      return { ...player, totalScore };
    });

    // 3. Filter and Sort
    return scored
      .filter(p => selectedPlayers.includes(p.id))
      .sort((a, b) => b.totalScore - a.totalScore);
  }, [weights, selectedPlayers, players]); // Added 'players' to dependencies

  const maxTotalScore = rankedData.length > 0 ? rankedData[0].totalScore : 100;

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 font-sans flex flex-col h-screen overflow-hidden">
      
      {/* HEADER */}
      <header className="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 shrink-0 z-20">
        <div className="max-w-7xl mx-auto px-4 py-3 flex flex-wrap gap-4 justify-between items-center">
          <div className="flex items-center gap-2">
            <div className="bg-indigo-600 p-1.5 rounded text-white"><Scale size={18}/></div>
            <div>
              <h1 className="text-lg font-bold leading-none">GOAT Ranker <span className="text-indigo-600">Pro</span></h1>
              <span className="text-[10px] text-gray-400 uppercase tracking-wider">English Edition v3.0</span>
            </div>
          </div>
          
          {/* Preset Selector */}
          <div className="flex items-center gap-2 bg-gray-100 dark:bg-gray-800 p-1 rounded-lg">
             <select 
               className="bg-transparent text-sm font-medium px-2 py-1 outline-none text-gray-700 dark:text-gray-200 min-w-[150px]"
               onChange={(e) => handlePresetChange(e.target.value)}
               defaultValue="universal"
             >
               <optgroup label="Standard Templates">
                 {Object.entries(DEFAULT_PRESETS).map(([key, val]) => (
                   <option key={key} value={key}>{val.name}</option>
                 ))}
               </optgroup>
               {Object.keys(customPresets).length > 0 && (
                 <optgroup label="My Custom Templates">
                   {Object.entries(customPresets).map(([key, val]) => (
                     <option key={`custom_${key}`} value={`custom_${key}`}>{val.name}</option>
                   ))}
                 </optgroup>
               )}
             </select>
             <button 
               onClick={saveCustomPreset}
               title="Save current weights as new template"
               className="p-1.5 hover:bg-white dark:hover:bg-gray-700 rounded text-gray-500 hover:text-indigo-600 transition-colors"
             >
               <Save size={16} />
             </button>
          </div>
        </div>
      </header>

      <main className="flex-grow flex overflow-hidden relative">
        
        {/* LEFT SIDEBAR: Weight Controls */}
        <aside className="w-80 border-r border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 flex-shrink-0 flex flex-col overflow-hidden hidden lg:flex">
          <div className="p-4 border-b border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-900/50">
            <h2 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Adjust Weights</h2>
            <p className="text-[11px] text-gray-400">Current Template: <span className="text-indigo-500 font-medium">{currentPresetName}</span></p>
          </div>
          
          <div className="flex-grow overflow-y-auto p-2 space-y-2">
            {Object.entries(CATEGORIES).map(([key, config]) => (
              <div key={key} className="border border-gray-200 dark:border-gray-800 rounded-lg overflow-hidden">
                 <button 
                    onClick={() => setExpandedCat(expandedCat === key ? null : key)}
                    className={`w-full flex items-center justify-between p-3 text-left transition-colors ${expandedCat === key ? 'bg-indigo-50 dark:bg-indigo-900/20' : 'hover:bg-gray-50 dark:hover:bg-gray-800'}`}
                 >
                    <div className="flex items-center gap-2">
                      <span className={config.color}>{config.icon}</span>
                      <span className="text-xs font-bold text-gray-700 dark:text-gray-200">{config.label}</span>
                    </div>
                    {expandedCat === key ? <ChevronUp size={14} className="text-gray-400"/> : <ChevronDown size={14} className="text-gray-400"/>}
                 </button>
                 
                 {expandedCat === key && (
                   <div className="p-3 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 animate-in slide-in-from-top-1">
                     {Object.entries(config.fields).map(([fieldKey, label]) => (
                       <Slider 
                         key={fieldKey} 
                         label={label} 
                         value={weights[fieldKey] || 0} 
                         onChange={(val) => setWeights(prev => ({...prev, [fieldKey]: val}))}
                       />
                     ))}
                   </div>
                 )}
              </div>
            ))}
          </div>
        </aside>

        {/* MAIN CONTENT: Rankings & Database */}
        <div className="flex-grow flex flex-col min-w-0 bg-slate-50 dark:bg-slate-950">
           
           {/* Toolbar */}
           <div className="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-800 bg-white/50 dark:bg-gray-900/50 backdrop-blur-sm sticky top-0 z-10">
              <div className="flex items-center gap-2">
                 <button 
                   onClick={() => setViewMode('rankings')}
                   className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${viewMode === 'rankings' ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300' : 'text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800'}`}
                 >
                   Rankings
                 </button>
                 <button 
                   onClick={() => setViewMode('database')}
                   className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${viewMode === 'database' ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300' : 'text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800'}`}
                 >
                   Player DB Selection
                 </button>
              </div>

              {viewMode === 'database' && (
                <div className="flex gap-2">
                  <button onClick={selectAllPlayers} className="text-xs text-blue-600 hover:underline">Select All</button>
                  <span className="text-gray-300">|</span>
                  <button onClick={deselectAllPlayers} className="text-xs text-red-500 hover:underline">Deselect All</button>
                </div>
              )}
           </div>

           {/* Content Area */}
           <div className="flex-grow overflow-y-auto p-4 lg:p-6 pb-32">
              
              {viewMode === 'rankings' ? (
                // --- RANKINGS VIEW ---
                <div className="max-w-3xl mx-auto space-y-4">
                  {rankedData.length === 0 ? (
                    <div className="text-center py-20 text-gray-400">
                      <Users size={48} className="mx-auto mb-4 opacity-50"/>
                      <p>No players selected. Go to "Player DB Selection" tab to add players.</p>
                    </div>
                  ) : (
                    rankedData.map((player, idx) => (
                      <div 
                        key={player.id} 
                        onClick={(e) => openEditModal(player, e)}
                        className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-4 flex items-center gap-4 transition-all hover:translate-x-1 cursor-pointer group hover:border-indigo-300 dark:hover:border-indigo-700"
                        title="Click to edit stats"
                      >
                        <div className={`
                          w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg border-2 
                          ${idx === 0 ? 'bg-yellow-50 border-yellow-200 text-yellow-600' : 
                            idx === 1 ? 'bg-gray-50 border-gray-200 text-gray-600' : 
                            idx === 2 ? 'bg-orange-50 border-orange-200 text-orange-600' : 
                            'bg-slate-50 border-slate-100 text-slate-400'}
                        `}>
                          {idx + 1}
                        </div>
                        
                        <div className="flex-grow">
                          <h3 className="font-bold text-gray-800 dark:text-gray-100 flex items-center gap-2">
                             {player.name}
                             <Edit3 size={12} className="opacity-0 group-hover:opacity-100 text-gray-400"/>
                          </h3>
                          <p className="text-xs text-gray-400">{player.team}</p>
                        </div>

                        {/* Bar Visual */}
                        <div className="hidden sm:block w-32 h-2 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                           <div 
                             className="h-full bg-indigo-600 rounded-full" 
                             style={{ width: `${(player.totalScore / maxTotalScore) * 100}%` }}
                           />
                        </div>

                        <div className="text-right">
                          <div className="text-2xl font-black text-indigo-600 dark:text-indigo-400">{player.totalScore.toFixed(0)}</div>
                          <div className="text-[10px] text-gray-400 uppercase tracking-widest">PTS</div>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              ) : (
                // --- DATABASE SELECTION VIEW ---
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                  {players.map(player => {
                    const isSelected = selectedPlayers.includes(player.id);
                    return (
                      <div 
                        key={player.id}
                        onClick={() => togglePlayerSelection(player.id)}
                        className={`
                          relative p-4 rounded-lg border flex items-center justify-between transition-all group
                          ${isSelected 
                            ? 'bg-blue-50 border-blue-200 dark:bg-blue-900/20 dark:border-blue-800' 
                            : 'bg-white border-gray-200 dark:bg-gray-800 dark:border-gray-700 opacity-70 hover:opacity-100'}
                        `}
                      >
                        <div className="cursor-pointer">
                          <div className="font-bold text-gray-800 dark:text-gray-200">{player.name}</div>
                          <div className="text-xs text-gray-500">{player.team}</div>
                        </div>
                        
                        <div className="flex items-center gap-3">
                           <button 
                             onClick={(e) => openEditModal(player, e)}
                             className="p-1.5 bg-white dark:bg-gray-700 rounded-full text-gray-400 hover:text-indigo-600 shadow-sm opacity-0 group-hover:opacity-100 transition-opacity"
                           >
                             <Edit3 size={14}/>
                           </button>
                           {isSelected 
                             ? <CheckSquare className="text-blue-600" size={20}/> 
                             : <Square className="text-gray-300" size={20}/>}
                        </div>
                      </div>
                    )
                  })}
                  
                  {/* Add Button */}
                  <div className="p-4 rounded-lg border border-dashed border-gray-300 dark:border-gray-700 flex flex-col items-center justify-center text-gray-400 gap-2 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors cursor-not-allowed">
                     <Plus size={24} />
                     <span className="text-xs">Add New Player</span>
                  </div>
                </div>
              )}
           </div>

           {/* --- EDIT MODAL OVERLAY --- */}
           {isEditModalOpen && editingPlayer && (
             <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in duration-200">
               <div className="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col border border-gray-200 dark:border-gray-800">
                 
                 {/* Modal Header */}
                 <div className="p-5 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50 rounded-t-2xl">
                   <div>
                     <h2 className="text-xl font-bold text-gray-800 dark:text-white">Edit Stats</h2>
                     <p className="text-sm text-gray-500">{editingPlayer.name} ({editingPlayer.team})</p>
                   </div>
                   <button onClick={() => setIsEditModalOpen(false)} className="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition-colors">
                     <X size={20} className="text-gray-500"/>
                   </button>
                 </div>

                 {/* Modal Body (Scrollable Form) */}
                 <div className="flex-grow overflow-y-auto p-6">
                   <div className="space-y-6">
                     {Object.entries(CATEGORIES).map(([catKey, config]) => (
                       <div key={catKey} className="bg-gray-50 dark:bg-gray-800/30 rounded-xl p-4 border border-gray-100 dark:border-gray-800">
                         <h3 className={`font-bold text-sm mb-3 flex items-center gap-2 ${config.color}`}>
                           {config.icon} {config.label}
                         </h3>
                         <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                           {Object.entries(config.fields).map(([fieldKey, label]) => (
                             <div key={fieldKey}>
                               <label className="block text-[10px] uppercase font-bold text-gray-400 mb-1 truncate" title={label}>
                                 {label}
                               </label>
                               <input 
                                 type="number" 
                                 step="any"
                                 value={editingPlayer.stats[fieldKey] || 0}
                                 onChange={(e) => handleEditChange(fieldKey, e.target.value)}
                                 className="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded px-2 py-1.5 text-sm font-mono focus:ring-2 focus:ring-indigo-500 outline-none"
                               />
                             </div>
                           ))}
                         </div>
                       </div>
                     ))}
                   </div>
                 </div>

                 {/* Modal Footer */}
                 <div className="p-5 border-t border-gray-100 dark:border-gray-800 flex justify-end gap-3 bg-white dark:bg-gray-900 rounded-b-2xl">
                   <button 
                     onClick={() => setIsEditModalOpen(false)}
                     className="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800 rounded-lg transition-colors"
                   >
                     Cancel
                   </button>
                   <button 
                     onClick={savePlayerEdits}
                     className="px-6 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md hover:shadow-lg transition-all flex items-center gap-2"
                   >
                     <Save size={16}/> Save & Recalculate
                   </button>
                 </div>

               </div>
             </div>
           )}

        </div>
      </main>
    </div>
  );
}